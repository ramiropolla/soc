diff --git a/ffmpeg.c b/ffmpeg.c
index e899180..aacf4c0 100644
--- a/ffmpeg.c
+++ b/ffmpeg.c
@@ -1237,7 +1237,8 @@ static void print_report(AVFormatContext **output_files,
 /* pkt = NULL means EOF (needed to flush decoder buffers) */
 static int output_packet(AVInputStream *ist, int ist_index,
                          AVOutputStream **ost_table, int nb_ostreams,
-                         const AVPacket *pkt)
+                         AVPacket *pkt,
+                         AVFormatContext *is)
 {
     AVFormatContext *os;
     AVOutputStream *ost;
@@ -1250,7 +1251,25 @@ static int output_packet(AVInputStream *ist, int ist_index,
     AVSubtitle subtitle, *subtitle_to_free;
     int got_subtitle;
     AVPacket avpkt;
-
+    if (ist && is && pkt && is->iformat && is->iformat->long_name &&
+        !strncmp(is->iformat->long_name, "CONCAT", 6) && is->nb_streams > pkt->stream_index &&
+        is->streams && is->streams[pkt->stream_index] && is->streams[pkt->stream_index]->codec) {
+        ist->st = is->streams[pkt->stream_index];
+        if (!ist->st->codec->codec) {
+            AVCodec *codec = avcodec_find_decoder(ist->st->codec->codec_id);
+            if (!codec) {
+                av_log(ist->st->codec, AV_LOG_ERROR, "Decoder (codec id %d) not found for input stream #%d.%d\n",
+                       ist->st->codec->codec_id, ist->file_index, ist->index);
+                return AVERROR(EINVAL);
+             }
+             if (avcodec_open(ist->st->codec, codec) < 0) {
+                av_log(ist->st->codec, AV_LOG_ERROR, "Error while opening decoder for input stream #%d.%d\n",
+                       ist->file_index, ist->index);
+                return AVERROR(EINVAL);
+             }
+         }
+    }
+     
     if(ist->next_pts == AV_NOPTS_VALUE)
         ist->next_pts= ist->pts;
 
@@ -2241,11 +2260,28 @@ static int av_encode(AVFormatContext **output_files,
         if (do_pkt_dump) {
             av_pkt_dump_log(NULL, AV_LOG_DEBUG, &pkt, do_hex_dump);
         }
+
+        if (pkt.stream_index >= nb_istreams && pkt.stream_index < is->nb_streams && is->streams[pkt.stream_index]) {
+            ist_table = av_realloc(ist_table, sizeof(*ist_table) * (pkt.stream_index + 1));
+            for (i = nb_istreams; i < pkt.stream_index + 1; ++i) {
+                ist = ist_table[i] = av_mallocz(sizeof(AVInputStream));
+                ist->st = is->streams[pkt.stream_index];
+                ist->file_index = file_index;
+                ist->decoding_needed = 1;
+                ist->is_start = 1;
+                ist->discard = 0;
+                ist->index = file_table[file_index].ist_index + pkt.stream_index;
+                ist->pts = 0;
+                ist->next_pts = AV_NOPTS_VALUE;
+            }
+            file_table[file_index].nb_streams = pkt.stream_index + 1;
+//            nb_istreams = pkt.stream_index + 1;
+        }
         /* the following test is needed in case new streams appear
            dynamically in stream : we ignore them */
         if (pkt.stream_index >= file_table[file_index].nb_streams)
             goto discard_packet;
-        ist_index = file_table[file_index].ist_index + pkt.stream_index;
+        ist_index = file_table[file_index].ist_index + pkt.stream_index - pkt.index_offset;
         ist = ist_table[ist_index];
         if (ist->discard)
             goto discard_packet;
@@ -2278,8 +2314,7 @@ static int av_encode(AVFormatContext **output_files,
         }
 
         //fprintf(stderr,"read #%d.%d size=%d\n", ist->file_index, ist->index, pkt.size);
-        if (output_packet(ist, ist_index, ost_table, nb_ostreams, &pkt) < 0) {
-
+        if (output_packet(ist, ist_index, ost_table, nb_ostreams, &pkt, is) < 0) {
             if (verbose >= 0)
                 fprintf(stderr, "Error while decoding stream #%d.%d\n",
                         ist->file_index, ist->index);
@@ -2300,7 +2335,7 @@ static int av_encode(AVFormatContext **output_files,
     for(i=0;i<nb_istreams;i++) {
         ist = ist_table[i];
         if (ist->decoding_needed) {
-            output_packet(ist, i, ost_table, nb_ostreams, NULL);
+            output_packet(ist, i, ost_table, nb_ostreams, NULL, is);
         }
     }
 
