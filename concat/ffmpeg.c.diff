diff --git a/ffmpeg.c b/ffmpeg.c
index e899180..8f4bc4c 100644
--- a/ffmpeg.c
+++ b/ffmpeg.c
@@ -70,6 +70,8 @@
 
 #undef exit
 
+#include "libavformat/concat.h"
+
 const char program_name[] = "FFmpeg";
 const int program_birth_year = 2000;
 
@@ -223,6 +225,8 @@ static unsigned int sws_flags = SWS_BICUBIC;
 
 static int64_t timer_start;
 
+PlaylistContext *playlist_ctx;
+
 static uint8_t *audio_buf;
 static uint8_t *audio_out;
 static uint8_t *audio_out2;
@@ -1237,7 +1241,8 @@ static void print_report(AVFormatContext **output_files,
 /* pkt = NULL means EOF (needed to flush decoder buffers) */
 static int output_packet(AVInputStream *ist, int ist_index,
                          AVOutputStream **ost_table, int nb_ostreams,
-                         const AVPacket *pkt)
+                         const AVPacket *pkt,
+                         AVFormatContext *is)
 {
     AVFormatContext *os;
     AVOutputStream *ost;
@@ -1250,7 +1255,24 @@ static int output_packet(AVInputStream *ist, int ist_index,
     AVSubtitle subtitle, *subtitle_to_free;
     int got_subtitle;
     AVPacket avpkt;
-
+    if (ist && is && pkt && is->iformat && is->iformat->long_name &&
+        !strncmp(is->iformat->long_name, "CONCAT", 6) && is->nb_streams > pkt->stream_index &&
+        is->streams && is->streams[pkt->stream_index] && is->streams[pkt->stream_index]->codec) {
+        ist->st = is->streams[pkt->stream_index];
+        if (!ist->st->codec->codec) {
+            AVCodec *codec = avcodec_find_decoder(ist->st->codec->codec_id);
+            if (!codec) {
+                av_log(ist->st->codec, AV_LOG_ERROR, "Decoder (codec id %d) not found for input stream #%d.%d\n",
+                       ist->st->codec->codec_id, ist->file_index, ist->index);
+                return AVERROR(EINVAL);
+             }
+             if (avcodec_open(ist->st->codec, codec) < 0) {
+                av_log(ist->st->codec, AV_LOG_ERROR, "Error while opening decoder for input stream #%d.%d\n",
+                       ist->file_index, ist->index);
+                return AVERROR(EINVAL);
+             }
+         }
+    }
     if(ist->next_pts == AV_NOPTS_VALUE)
         ist->next_pts= ist->pts;
 
@@ -2278,8 +2300,7 @@ static int av_encode(AVFormatContext **output_files,
         }
 
         //fprintf(stderr,"read #%d.%d size=%d\n", ist->file_index, ist->index, pkt.size);
-        if (output_packet(ist, ist_index, ost_table, nb_ostreams, &pkt) < 0) {
-
+        if (output_packet(ist, ist_index, ost_table, nb_ostreams, &pkt, is) < 0) {
             if (verbose >= 0)
                 fprintf(stderr, "Error while decoding stream #%d.%d\n",
                         ist->file_index, ist->index);
@@ -2300,7 +2321,7 @@ static int av_encode(AVFormatContext **output_files,
     for(i=0;i<nb_istreams;i++) {
         ist = ist_table[i];
         if (ist->decoding_needed) {
-            output_packet(ist, i, ost_table, nb_ostreams, NULL);
+            output_packet(ist, i, ost_table, nb_ostreams, NULL, is);
         }
     }
 
@@ -2852,6 +2873,7 @@ static void opt_input_file(const char *filename)
     AVFormatParameters params, *ap = &params;
     int err, i, ret, rfps, rfps_base;
     int64_t timestamp;
+    char concatenate_video_files = 0;
 
     if (!strcmp(filename, "-"))
         filename = "pipe:";
@@ -2886,12 +2908,25 @@ static void opt_input_file(const char *filename)
     ic->subtitle_codec_id= find_codec_or_die(subtitle_codec_name, CODEC_TYPE_SUBTITLE, 0);
     ic->flags |= AVFMT_FLAG_NONBLOCK;
 
-    /* open the input file with generic libav function */
-    err = av_open_input_file(&ic, filename, file_iformat, 0, ap);
-    if (err < 0) {
-        print_error(filename, err);
-        av_exit(1);
+    err = 0;
+    playlist_ctx = ff_playlist_from_encodedstring(filename, ',');
+    if (playlist_ctx) {
+        av_log(ic, AV_LOG_DEBUG, "Generating playlist from %s\n", filename);
+        concatenate_video_files = 1;
+        av_strlcpy(ic->filename, filename, sizeof(ic->filename));
+        ic->iformat = ff_concat_alloc_demuxer();
+        ff_playlist_set_context(ic, playlist_ctx);
+        ff_playlist_populate_context(playlist_ctx, playlist_ctx->pe_curidx);
+        ff_playlist_set_streams(ic);
+    } else {
+        /* open the input file with generic libav function */
+        err = av_open_input_file(&ic, filename, file_iformat, 0, ap);
+        if (err < 0) {
+            print_error(filename, err);
+            av_exit(1);
+        }
     }
+
     if(opt_programid) {
         int i;
         for(i=0; i<ic->nb_programs; i++)
@@ -3000,6 +3035,8 @@ static void opt_input_file(const char *filename)
         dump_format(ic, nb_input_files, filename, 0);
 
     nb_input_files++;
+    if (concatenate_video_files)
+        nb_input_files = 1;
     file_iformat = NULL;
     file_oformat = NULL;
 
