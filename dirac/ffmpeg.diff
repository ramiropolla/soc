Index: libavcodec/golomb.c
===================================================================
--- libavcodec/golomb.c	(revision 9734)
+++ libavcodec/golomb.c	(working copy)
@@ -1,6 +1,7 @@
 /*
  * exp golomb vlc stuff
  * Copyright (c) 2003 Michael Niedermayer <michaelni@gmx.at>
+ * Copyright (c) 2007 Marco Gerards <marco@gnu.org>
  *
  * This file is part of FFmpeg.
  *
@@ -23,7 +24,7 @@
  * @file golomb.c
  * @brief
  *     exp golomb vlc stuff
- * @author Michael Niedermayer <michaelni@gmx.at>
+ * @author Michael Niedermayer <michaelni@gmx.at> and Marco Gerards <marco@gnu.org>
  */
 
 #include "common.h"
@@ -153,3 +154,39 @@
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
 };
+
+const uint8_t ff_interleaved_dirac_golomb_vlc_len[256]={
+9,9,7,7,9,9,7,7,5,5,5,5,5,5,5,5,
+9,9,7,7,9,9,7,7,5,5,5,5,5,5,5,5,
+3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,
+3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,
+9,9,7,7,9,9,7,7,5,5,5,5,5,5,5,5,
+9,9,7,7,9,9,7,7,5,5,5,5,5,5,5,5,
+3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,
+3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,
+1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
+1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
+1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
+1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
+1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
+1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
+1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
+1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,};
+
+const uint8_t ff_interleaved_dirac_golomb_vlc_code[256]={
+0, 1, 0, 0, 2, 3, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 
+4, 5, 2, 2, 6, 7, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
+8, 9, 4, 4, 10,11,5, 5, 2, 2, 2, 2, 2, 2, 2, 2, 
+12,13,6, 6, 14,15,7, 7, 3, 3, 3, 3, 3, 3, 3, 3, 
+1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
+1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
+0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,};
Index: libavcodec/golomb.h
===================================================================
--- libavcodec/golomb.h	(revision 9734)
+++ libavcodec/golomb.h	(working copy)
@@ -2,6 +2,7 @@
  * exp golomb vlc stuff
  * Copyright (c) 2003 Michael Niedermayer <michaelni@gmx.at>
  * Copyright (c) 2004 Alex Beregszaszi
+ * Copyright (c) 2007 Marco Gerards <marco@gnu.org>
  *
  * This file is part of FFmpeg.
  *
@@ -24,7 +25,7 @@
  * @file golomb.h
  * @brief
  *     exp golomb vlc stuff
- * @author Michael Niedermayer <michaelni@gmx.at> and Alex Beregszaszi
+ * @author Michael Niedermayer <michaelni@gmx.at>, Alex Beregszaszi and Marco Gerards
  */
 
 #ifndef AVCODEC_GOLOMB_H
@@ -43,6 +44,8 @@
 extern const uint8_t ff_interleaved_golomb_vlc_len[256];
 extern const uint8_t ff_interleaved_ue_golomb_vlc_code[256];
 extern const  int8_t ff_interleaved_se_golomb_vlc_code[256];
+extern const uint8_t ff_interleaved_dirac_golomb_vlc_len[256];
+extern const uint8_t ff_interleaved_dirac_golomb_vlc_code[256];
 
 
  /**
@@ -106,6 +109,59 @@
     }
 }
 
+static inline int dirac_get_ue_golomb(GetBitContext *gb){
+    uint32_t buf;
+    uint32_t ret = 1;
+
+    OPEN_READER(re, gb);
+    while (1) {
+        UPDATE_CACHE(re, gb);
+        buf = GET_CACHE(re, gb);
+
+        buf >>= 32 - 8;
+        LAST_SKIP_BITS(re, gb, FFMIN(ff_interleaved_dirac_golomb_vlc_len[buf], 8));
+
+        ret <<= (ff_interleaved_dirac_golomb_vlc_len[buf] - 1) >> 1;
+        ret |= ff_interleaved_dirac_golomb_vlc_code[buf];
+        if (ff_interleaved_dirac_golomb_vlc_len[buf] != 9)
+            break;
+    }
+    CLOSE_READER(re, gb);
+
+    return ret - 1;
+}
+
+static inline int dirac_get_se_golomb(GetBitContext *gb){
+    uint32_t buf;
+    uint32_t ret = 1;
+
+    OPEN_READER(re, gb);
+    while (1) {
+        UPDATE_CACHE(re, gb);
+
+        buf = GET_CACHE(re, gb);
+        buf >>= 32 - 8;
+        LAST_SKIP_BITS(re, gb, FFMIN(ff_interleaved_dirac_golomb_vlc_len[buf], 8));
+
+        ret <<= (ff_interleaved_dirac_golomb_vlc_len[buf] - 1) >> 1;
+        ret |= ff_interleaved_dirac_golomb_vlc_code[buf];
+        if (ff_interleaved_dirac_golomb_vlc_len[buf] != 9)
+            break;
+    }
+    ret--;
+
+    buf = GET_CACHE(re, gb);
+    if (ret) {
+        LAST_SKIP_BITS(re, gb, 1);
+        if (buf & 0x80000000)
+            ret = -ret;
+    }
+
+    CLOSE_READER(re, gb);
+
+    return ret;
+}
+
 /**
  * read unsigned truncated exp golomb code.
  */
Index: libavcodec/Makefile
===================================================================
--- libavcodec/Makefile	(revision 9734)
+++ libavcodec/Makefile	(working copy)
@@ -52,6 +52,7 @@
 OBJS-$(CONFIG_CSCD_DECODER)            += cscd.o
 OBJS-$(CONFIG_CYUV_DECODER)            += cyuv.o
 OBJS-$(CONFIG_DCA_DECODER)             += dca.o
+OBJS-$(CONFIG_DIRAC_DECODER)           += dirac.o
 OBJS-$(CONFIG_DNXHD_DECODER)           += dnxhddec.o
 OBJS-$(CONFIG_DSICINVIDEO_DECODER)     += dsicinav.o
 OBJS-$(CONFIG_DSICINAUDIO_DECODER)     += dsicinav.o
@@ -305,6 +306,7 @@
 OBJS-$(CONFIG_AC3_PARSER)              += ac3_parser.o ac3tab.o aac_ac3_parser.o
 OBJS-$(CONFIG_CAVSVIDEO_PARSER)        += cavs_parser.o
 OBJS-$(CONFIG_DCA_PARSER)              += dca_parser.o
+OBJS-$(CONFIG_DIRAC_PARSER)            += dirac_parser.o
 OBJS-$(CONFIG_DVBSUB_PARSER)           += dvbsub_parser.o
 OBJS-$(CONFIG_DVDSUB_PARSER)           += dvdsub_parser.o
 OBJS-$(CONFIG_H261_PARSER)             += h261_parser.o
Index: libavcodec/allcodecs.c
===================================================================
--- libavcodec/allcodecs.c	(revision 9734)
+++ libavcodec/allcodecs.c	(working copy)
@@ -68,6 +68,7 @@
     REGISTER_DECODER(CLJR, cljr);
     REGISTER_DECODER(CSCD, cscd);
     REGISTER_DECODER(CYUV, cyuv);
+    REGISTER_DECODER(DIRAC, dirac);
     REGISTER_DECODER(DNXHD, dnxhd);
     REGISTER_DECODER(DSICINVIDEO, dsicinvideo);
     REGISTER_ENCDEC (DVVIDEO, dvvideo);
@@ -262,6 +263,7 @@
     REGISTER_PARSER (AC3, ac3);
     REGISTER_PARSER (CAVSVIDEO, cavsvideo);
     REGISTER_PARSER (DCA, dca);
+    REGISTER_PARSER (DIRAC, dirac);
     REGISTER_PARSER (DVBSUB, dvbsub);
     REGISTER_PARSER (DVDSUB, dvdsub);
     REGISTER_PARSER (H261, h261);
Index: libavcodec/allcodecs.h
===================================================================
--- libavcodec/allcodecs.h	(revision 9734)
+++ libavcodec/allcodecs.h	(working copy)
@@ -92,6 +92,7 @@
 extern AVCodec cscd_decoder;
 extern AVCodec cyuv_decoder;
 extern AVCodec dca_decoder;
+extern AVCodec dirac_decoder;
 extern AVCodec dnxhd_decoder;
 extern AVCodec dsicinaudio_decoder;
 extern AVCodec dsicinvideo_decoder;
Index: libavcodec/avcodec.h
===================================================================
--- libavcodec/avcodec.h	(revision 9734)
+++ libavcodec/avcodec.h	(working copy)
@@ -166,6 +166,7 @@
     CODEC_ID_BETHSOFTVID,
     CODEC_ID_PTX,
     CODEC_ID_TXD,
+    CODEC_ID_DIRAC,
 
     /* various PCM "codecs" */
     CODEC_ID_PCM_S16LE= 0x10000,
@@ -2767,6 +2768,7 @@
 extern AVCodecParser ac3_parser;
 extern AVCodecParser cavsvideo_parser;
 extern AVCodecParser dca_parser;
+extern AVCodecParser dirac_parser;
 extern AVCodecParser dvbsub_parser;
 extern AVCodecParser dvdsub_parser;
 extern AVCodecParser h261_parser;
Index: libavformat/Makefile
===================================================================
--- libavformat/Makefile	(revision 9734)
+++ libavformat/Makefile	(working copy)
@@ -36,6 +36,7 @@
 OBJS-$(CONFIG_CRC_MUXER)                 += crc.o
 OBJS-$(CONFIG_DAUD_DEMUXER)              += daud.o
 OBJS-$(CONFIG_DC1394_DEMUXER)            += dc1394.o
+OBJS-$(CONFIG_DIRAC_DEMUXER)             += raw.o
 OBJS-$(CONFIG_DSICIN_DEMUXER)            += dsicin.o
 OBJS-$(CONFIG_DTS_DEMUXER)               += raw.o
 OBJS-$(CONFIG_DV_DEMUXER)                += dv.o
Index: libavformat/raw.c
===================================================================
--- libavformat/raw.c	(revision 9734)
+++ libavformat/raw.c	(working copy)
@@ -316,6 +316,7 @@
         av_set_pts_info(st, 64, ap->time_base.num, ap->time_base.den);
     } else if ( st->codec->codec_id == CODEC_ID_MJPEG ||
                 st->codec->codec_id == CODEC_ID_MPEG4 ||
+                st->codec->codec_id == CODEC_ID_DIRAC ||
                 st->codec->codec_id == CODEC_ID_H264) {
         av_set_pts_info(st, 64, 1, 25);
     }
@@ -408,6 +409,14 @@
     return 0;
 }
 
+static int dirac_probe(AVProbeData *p)
+{
+    if (AV_RL32(p->buf) == MKTAG('B', 'B', 'C', 'D'))
+        return AVPROBE_SCORE_MAX;
+    else
+        return 0;
+}
+
 static int ac3_probe(AVProbeData *p)
 {
     int max_frames, first_frames = 0, frames;
@@ -507,6 +516,18 @@
 };
 #endif //CONFIG_MUXERS
 
+AVInputFormat dirac_demuxer = {
+    "dirac",
+    "raw dirac",
+    0,
+    dirac_probe,
+    video_read_header,
+    raw_read_partial_packet,
+    raw_read_close,
+    .flags= AVFMT_GENERIC_INDEX,
+    .value = CODEC_ID_DIRAC,
+};
+ 
 AVInputFormat dts_demuxer = {
     "dts",
     "raw dts",
Index: libavformat/allformats.c
===================================================================
--- libavformat/allformats.c	(revision 9734)
+++ libavformat/allformats.c	(working copy)
@@ -66,6 +66,7 @@
     REGISTER_MUXER   (CRC, crc);
     REGISTER_DEMUXER (DAUD, daud);
     REGISTER_DEMUXER (DC1394, dc1394);
+    REGISTER_DEMUXER (DIRAC, dirac);
     REGISTER_DEMUXER (DSICIN, dsicin);
     REGISTER_DEMUXER (DTS, dts);
     REGISTER_MUXDEMUX(DV, dv);
Index: libavformat/allformats.h
===================================================================
--- libavformat/allformats.h	(revision 9734)
+++ libavformat/allformats.h	(working copy)
@@ -39,6 +39,7 @@
 extern AVInputFormat c93_demuxer;
 extern AVInputFormat daud_demuxer;
 extern AVInputFormat dc1394_demuxer;
+extern AVInputFormat dirac_demuxer;
 extern AVInputFormat dsicin_demuxer;
 extern AVInputFormat dts_demuxer;
 extern AVInputFormat dv1394_demuxer;
